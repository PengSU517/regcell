---
title: "Simulation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{simu}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = T,
  message = F, 
  warning = F
)

#https://pengsu517.github.io/robcovsel
```

```{r , echo=FALSE}
library(tidyverse)
library(gridExtra)
library(grid)
library(plotly)
library(stargazer)
library(reshape2)
options(show.error.locations = TRUE)
```


```{r, message = F, warning = F,echo=FALSE}
load("result_simu_p20_pr5.RData")
#assign('result111', get(load('result_simu_p200_new2.RData')))
```

```{r}
result1 = as.data.frame(t(as.data.frame(result)))
result1 = result1 %>% mutate(across(c(1:4, 12:21), as.numeric), 
                             across(5:11, as.factor), 
                             bacc = (TP/pr + (p-pr-FP)/(p-pr))/2)
#glimpse(result1)
#result1$fp = result1$fp-5
levels(result1$e) = c("e = 0%", "e = 2%", "e = 5%", "e = 10%")
levels(result1$df) = c( "Normal","t(3)", "t(5)")
levels(result1$gamma) = c( "2", "4", "6", "8", "10", " ")

result1$df = factor(result1$df, levels = c("t(3)", "t(5)", "Normal"))
result1$method = factor(result1$method, levels = c("slm",   "sss", "rlars", "smrlarsrow", "smrlarscell"))
result1$method = factor(result1$method, labels = c("Lasso",   "SShootS", "Rlars", "CRSM_row" , "CRSM_cell"))
```


```{r , warning = F, echo=FALSE}
result2 = result1
result2[(result2$e=="e = 0%")&(result2$gamma!="2"),]=NA
result2 = result2[complete.cases(result2),]
result2$gamma[result2$e=="e = 0%"] = " "
names(result2)[c(12:15,21,22)] = c("MAPE", "RTMSPE", "TP", "FP", "Time", "BACC")
```

```{r}
result_new= result2
save(result_new, file = "result_simu_new_cleaned.RData")
load("result_simu_new_cleaned.RData")
```


```{r fig.width=10, fig.height=8, echo=FALSE}

#result2[which.max(result2$rtmspe),] 

result3 = result2 #%>% filter(df == "t(5)")


p1 = ggplot(data = result3)+
  geom_boxplot(aes(fill = method, x = gamma, y = MAPE))+
  facet_grid(df~e, scales = "free", space = "free_x") +
  #scale_y_continuous(limits = quantile(result3$MAPE, c(0.1, 0.8)))+
  theme_bw()+
  labs(x = expression(gamma*": magnitude of outlyingness"))+
  theme(text= element_text(size=12), 
        #axis.text.x = element_blank(),
        legend.position = "right")
p1


#ggsave("plots_mape_p200.eps", plot = p1, width = 10,height = 7)
```

```{r}

summary = result2 %>% group_by(n,p,e,r,gamma, df, method,outtype) %>% summarise(
  TPR = mean(TP/pr, na.rm = T),
  FPR = mean(FP/(p-pr), na.rm = T),
  TNR = 1-FPR,
  BACCA = mean(BACC),
  MAPE = mean(MAPE), 
  RTMSPE = mean(RTMSPE),
  Time = mean(Time))


```

```{r fig.width=10, fig.height=8, echo=FALSE}
summary3 = summary #%>% filter(df == "Normal")
summary3$BACC = summary3$BACCA
#summary3 = reshape2::melt(summary3, id = "gamma")

summary3
p2 = ggplot(data = summary3, aes(x = gamma, y = BACC, group = method))+
  geom_point(aes(color = method))+
  geom_line(aes(linetype = method, color = method))+ 
  facet_grid(df~e, scales = "free", space = "free_x") +
  scale_y_continuous(limits = c(0, 1))+
  theme_bw()+
  labs(x = expression(gamma*": magnitude of outlyingness"))+
  theme(text= element_text(size=12), 
        #axis.text.x = element_blank(),
        legend.position = "right")
p2


#ggsave("plots_fpr_p20.eps", plot = p2, width = 10,height = 7)
```





```{r, fig.width=12, fig.height=12}
library(cellWise)
set.seed(5)
dataset = srlmcell::genevar(p = 2, n = 20, beta = c(1,1), df = 0, r = 0, e = 0)


x = dataset$x
x[1,1] = c(6)
x[2,1] = c(-6.5)
y = x[,1] + x[,2]+rnorm(n = 20, sd = 0.5)
x[3,1] = c(6)
x[1,2] = c(6)

fit1 <- DDC(x)



x = rbind(x, fit1$Ximp[1:3,])
label = factor(c(rep(1,20), rep(2,3)),labels = c("Origion", "Imputation"))
x = cbind(x, label)
mat  = as.data.frame(cbind(y,x))
colnames(mat) = c("y", "X1", "X2","label")
#mat$label = factor(c(rep(1,20), 2:4),labels = c("clean observations", "Point a", "Point b", "Point c"))

#pairs(mat[,1:3], pch = 19, xaxt='n', yaxt='n')
upper.panel<-function(x, y){
  points(x,y, pch=19, col=c("black", "red")[mat$label], cex = 2)
  r <- round(cor(x, y), digits=2)
  #usr <- par("usr")
  #on.exit(par(usr))
  # #par(usr = c(0, 1, 0, 1))
  # text(x[3], y[3], "a", col = "white")
  # text(x[2], y[2], "b", col = "white")
  # text(x[1], y[1], "c", col = "white")
  # text(x[23]-0.4, y[23], "a'")
  # text(x[22]-0.4, y[22], "b'")
  # text(x[21]-0.4, y[21], "c'")
}
pairs(mat[,1:3], lower.panel = NULL, 
      upper.panel = upper.panel)



fit1$Ximp[1:3,]
```

```{r}
plot(fit1$Ximp, col = "red", pch = 19, cex = 0.5, xlim = c(-6, 6), ylim = c(-6, 6), font = 1)
points(dataset$x, pch = 19, cex = 0.5,)
#text(fit1$Ximp, labels=1:n, cex=1, font=2)
```


```{r}
upper.panel<-function(x, y){
  points(x,y, pch=19, col=c("red", "green3", "blue")[iris$Species])
  r <- round(cor(x, y), digits=2)
  txt <- paste0("R = ", r)
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  text(0.5, 0.9, txt)
}
pairs(iris[,1:3], lower.panel = NULL, 
      upper.panel = upper.panel)
```


```{r}
library(GGally)

ggpairs(mat, columns = 1:3, ggplot2::aes(colour = label), upper = NULL, , axisLabels="none") 
```




```{r, message = F, warning = F,echo=FALSE}
library(tidyverse)
load("result_regression_new.RData")

result1 = as.data.frame(t(as.data.frame(result)))
result1 = result1 %>% mutate(across(c(1:4, 12:18), as.numeric), 
                             across(5:11, as.factor))

unique(result1$method)
levels(result1$e) = c("e = 0%", "e = 2%", "e = 5%", "e = 10%")
levels(result1$df) = c( "Normal","t(3)", "t(5)")
levels(result1$gamma) = c( "2", "4", "6", "8", "10", " ")
result1$df = factor(result1$df, levels = c("t(3)", "t(5)", "Normal"))

#result1[which.max(result1$MAPE),]
levels(result1$method)
```

```{r , warning = F, echo=FALSE}
result2 = result1
result2[(result2$e=="e = 0%")&(result2$gamma!="2"),]=NA
result2 = result2[complete.cases(result2$m),]
result2$gamma[result2$e=="e = 0%"] = " "
levels(result2$method) = c("RobReg_DDCimp", "RobReg_Rlars_Cell_Restoration","RobReg_Rlars_Row_Restoration",
                           "RobSel_DDCimp", "RobSel_Rlars_Cell_Restoration","RobSel_Rlars_Row_Restoration")
```

```{r}
result_regression_new= result2
save(result_regression_new, file = "result_simu_regression_new_cleaned.RData")
load("result_simu_regression_new_cleaned.RData")
#result_high$method %in% c("sss",   "rlars", "smddcrow", "smddccell", "smrlarsrow", "smrlarscell")
```

```{r fig.width=10, fig.height=10, echo=FALSE}

result3 = result2 %>% filter(df == "Normal")
#result3 = result2 %>% filter(method == "RobReg_DDCimp")
result3 = result3[complete.cases(result3$TPD),]


p1 = ggplot(data = result3)+
  geom_boxplot(aes(fill = method, x = gamma, y = TND))+
  facet_grid(outtype~e, scales = "free", space = "free_x") +
  #scale_y_continuous(limits = c(0,10))+
  theme_bw()+
  labs(x = expression(gamma*": magnitude of outlyingness"))+
  theme(text= element_text(size=12), 
        #axis.text.x = element_blank(),
        legend.position = "right")
p1

result3[which.max(result3$MAPE),]

levels(result3$method)
head(result3$TPD)
#ggsave("plots_time_p200.eps", plot = p1, width = 10,height = 7)
```


```{r}
library(pense)
data(freeny)
x <- as.matrix(freeny[ , 2:5])
regpath <- pense(x, freeny$y, alpha = 0.5)
plot(regpath)
# Extract the coefficients at a certain penalization level
coef(regpath, lambda = regpath$lambda[[1]][[40]])


# What penalization level leads to good prediction performance?
set.seed(123)
cv_results <- pense_cv(x, freeny$y, alpha = 0.5,
cv_repl = 2, cv_k = 4)
plot(cv_results, se_mult = 1)
# Extract the coefficients at the penalization level with
# smallest prediction error ...
coef(cv_results)
# ... or at the penalization level with prediction error
# statistically indistinguishable from the minimum.
coef(cv_results, lambda = '1-se')
```

```{r}
library(optimParallel)
negll <- function(par, x){
-sum(dnorm(x=x, mean=par[1], sd=par[2], log=TRUE))
}
set.seed(13); x <- rnorm(1000, 5, 2)
cl <- makeCluster(2) # set the number of processor cores
setDefaultCluster(cl=cl) # set 'cl' as default cluster
optimParallel(par=c(1,1), fn=negll, x=x, lower=c(-Inf, .0001))
```


```{r}
#3 variables with c,alpha estimation

cl <- makeCluster(8) # set the number of processor cores
setDefaultCluster(cl=cl) 

clusterEvalQ(cl, library(MASS))
clusterEvalQ(cl, library(mvtnorm))
clusterEvalQ(cl, library(numDeriv))

#clusterExport(cl,'N')
#clusterExport(cl,'X')
#clusterExport(cl,'Y')
#clusterExport(cl,'Z')
#clusterExport(cl,'T')
library(MASS)
library(mvtnorm)
library(numDeriv)
#set.seed(13)
  N =20
  c = 0.5
  alpha1 = -0.5 
  alpha2 = 0.5
  sigma_b = 1
  sig1 = 1
  
  #Generate observed data
  rho = 0.9
  
  
  n = sample(3:10,N,replace = TRUE)
  
  c = c(c, Inf)
  alpha = c(-Inf,alpha1, alpha2, Inf)
  R_l = matrix(rep(rho, 9), ncol = 3)
  sig = c(sig1,1,1)
  diag(R_l) = c(1,1,1)
  Sig_l = diag(sig)%*%R_l%*%diag(sig)
  
  beta_y = c(0.3,0.3)
  beta_z = c(0.4,0.4)
  beta_t = c(0.1,0.1)


X = matrix(rnorm(sum(n)*2),ncol = 2)

  #generate data
  sub = NULL
  times = NULL
  b1 = NULL
  b2 = NULL
  b3 = NULL
  r_e = matrix(rep(0,sum(n*3)),ncol = 3)
  for(i in 1:N){
    sub = c(sub,rep(i,n[i]))
    times = c(times,1:n[i])
    b1 = c(b1,rep(rnorm(1,mean=0,sd=sigma_b),n[i]))
    b2 = c(b2,rep(rnorm(1,mean=0,sd=sigma_b),n[i]))
    b3 = c(b3,rep(rnorm(1,mean=0,sd=sigma_b),n[i]))
  }
  
  data_o = mvrnorm(sum(n), rep(0, 3), Sigma = Sig_l)
  
  #Generate latent variables
  Z_l = data_o[,2]+b2+X%*%beta_z
  T_l = data_o[,3]+b3+X%*%beta_t
  
  #Generate observed data
  Y = as.numeric(data_o[,1]+b1+X%*%beta_y)
  
  
  Z = as.numeric(Z_l> c[1])
  T = rep(0, sum(n))
  for(i in 1:sum(n)){
    if (T_l[i] <= alpha[2]) T[i] = 1
    else if (T_l[i] > alpha[2] & T_l[i] <= alpha[3]) T[i] = 2
    else T[i] = 3}
  
  
C = c(-Inf,  qnorm(sum(Z)/sum(n)), Inf) 
 
Alpha = c(-Inf,qnorm(sum(T==2)/sum(n)),qnorm(1-sum(T==3)/sum(n)),Inf)              
        
  likelihood = function(parameter,X=X,Y=Y,Z=Z,T=T,C=C,Alpha=Alpha,N=N,n=n,sub=sub){
    r = parameter[1:3]
    
    sigma = parameter[4]^2
    
    s = sqrt(sigma)
    
    sigma_b = parameter[5]^2
    
    sig_b = sqrt(sigma_b)
    
    betay = parameter[6:7]
    betaz = parameter[8:9]
    betat = parameter[10:11]
    
    
    if(r[1]>=1|r[1]<=(-1)|r[2]>=1|r[2]<=(-1)|r[3]>=1|r[3]<=(-1)|(r[3]-r[1]*r[2])<=0) 
      return(100000000) 
    
    else{
      r_condition = (r[3]-r[1]*r[2])/sqrt((1-r[1]^2)*(1-r[2]^2))
      
      if (r_condition^2>1) return (100000000)
      
      
      else{ 
        
        R_condition = matrix(c(1,r_condition,r_condition,1),ncol=2) 
        
        l=0
        
        for (i in 1:N){
          
          f_N<- function(b){
            u = (Y[sub==i]-X[sub==i,]%*%betay-b[1])/s
            v1 = C[Z[sub==i]+1]-b[2]-X[sub==i,]%*%betaz
            v2 = C[Z[sub==i]+2]-b[2]-X[sub==i,]%*%betaz
            w1 = Alpha[T[sub==i]]-b[3]-X[sub==i,]%*%betat
            w2 = Alpha[T[sub==i]+1]-b[3]-X[sub==i,]%*%betat 
            
            
            upper1 = cbind((v1-r[1]*u)/sqrt(1-r[1]^2),(v2-r[1]*u)/sqrt(1-r[1]^2))
            upper2 = cbind((w1-r[2]*u)/sqrt(1-r[2]^2),(w2-r[2]*u)/sqrt(1-r[2]^2))
            fij_c = 1
            for (j in 1:n[i]){
            fij_c = fij_c*dnorm(u[j])/s*(mvtnorm::pmvnorm(upper =c(upper1[j,1],upper2[j,1]),corr=R_condition)-
                                  mvtnorm::pmvnorm(upper =c(upper1[j,1],upper2[j,2]),corr=R_condition)-
                                  mvtnorm::pmvnorm(upper =c(upper1[j,2],upper2[j,1]),corr=R_condition)+
                                  mvtnorm::pmvnorm(upper =c(upper1[j,2],upper2[j,2]),corr=R_condition))[1]}
            f_N = -log(fij_c*dnorm(b[1],sd = sig_b)*dnorm(b[2],sd = sig_b)*dnorm(b[3],sd = sig_b))
            return(f_N)}
          b_0 = nlm(f_N,c(0.1,0.1,0.1))$estimate
          #optim(c(0.1,0.1),f_N)$par
          H = numDeriv::hessian(f_N,b_0)
          f_i = (2*pi)^(3/2)/sqrt(abs(det(H)))*exp(-f_N(b_0))
          l = l+log(f_i)
        }
      return(-l)}}
  }
  

 
  
  
  
  #initial value
  parameter = c(cor(Y,Z)
                ,cor(Y,T)
                ,cor(Z,T)
                ,0.5*var(Y),0.5*var(Y),lm(Y~X)$coef[2:3],lm(Z~X)$coef[2:3],
                lm(T~X)$coef[2:3])
 # likelihood(parameter)
  # true = c(rho,rho,rho,sig1,sigma_b,c,alpha1,alpha2)
 # rst = optim(parameter,likelihood,X=X,Y=Y,Z=Z,T=T,C=C,Alpha=Alpha,N=N,method="L-BFGS-B")$par


#nlm(likelihood,parameter)

#clusterExport(cl,'N')
#clusterExport(cl,'X')
#clusterExport(cl,'Y')
#clusterExport(cl,'Z')
#clusterExport(cl,'T')


optimParallel(par=unname(parameter),fn=likelihood,
X=X,Y=Y,Z=Z,T=T,C=C,Alpha=Alpha,N=N,n=n,sub=sub,
lower=rep(.0001,11))

setDefaultCluster(cl=NULL); stopCluster(cl)
```

