---
title: "Simulation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{simu}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = T,
  message = F, 
  warning = F
)

#https://pengsu517.github.io/robcovsel
```

```{r , echo=FALSE}
library(tidyverse)
library(gridExtra)
library(grid)
library(plotly)
library(stargazer)
library(reshape2)
options(show.error.locations = TRUE)
```


```{r, message = F, warning = F,echo=FALSE}
load("result_simu_p20_newcode_1201.RData")
#assign('result111', get(load('result_simu_p200_new2.RData')))
```

```{r}
result1 = as.data.frame(t(as.data.frame(result)))
result1 = result1 %>% mutate(across(c(1:4, 12:21), as.numeric), 
                             across(5:11, as.factor), 
                             bacc = (TP/pr + (p-pr-FP)/(p-pr))/2)
#glimpse(result1)
#result1$fp = result1$fp-5
max(result1$m)

levels(result1$e) = c("e = 0%", "e = 2%", "e = 5%", "e = 10%")
levels(result1$df) = c("Normal", "t(3)", "t(5)")
levels(result1$gamma) = c(" ", "2", "4", "6", "8", "10")

result1$df = factor(result1$df, levels = c("t(3)", "t(5)", "Normal"))
#result1$method = factor(result1$method, levels = c("rlars", "rob_row", "rob_cell", "rob_imp", "ols_row", "ols_cell", "ols_imp"))
```


```{r , warning = F, echo=FALSE}
result2 = result1[complete.cases(result1),]
#result2[(result2$e=="e = 0%")&(result2$gamma!="2"),]=NA
#result2 = result2[complete.cases(result2),]
#result2$gamma[result2$e=="e = 0%"] = " "
names(result2)[c(12:15,21,22)] = c("MAPE", "RTMSPE", "TP", "FP", "Time", "BACC")

```

```{r}
result_new= result2
save(result_new, file = "result_simu_new_cleaned.RData")
load("result_simu_new_cleaned.RData")
```


```{r fig.width=10, fig.height=8, echo=FALSE}

#result2[which.max(result2$rtmspe),] 

result3 = result2 %>% filter(pr==10)


p1 = ggplot(data = result3)+
  geom_boxplot(aes(fill = method, x = gamma, y = MAPE))+
  facet_grid(df~e, scales = "free", space = "free_x") +
  #scale_y_continuous(limits = quantile(result3$MAPE, c(0.1, 0.8)))+
  theme_bw()+
  labs(x = expression(gamma*": magnitude of outlyingness"))+
  theme(text= element_text(size=12), 
        #axis.text.x = element_blank(),
        legend.position = "right")
p1


#ggsave("plots_mape_p200.eps", plot = p1, width = 10,height = 7)
```

```{r}

summary = result2 %>% group_by(n,p,e,r,gamma, df, method,outtype) %>% summarise(
  TPR = mean(TP/pr, na.rm = T),
  FPR = mean(FP/(p-pr), na.rm = T),
  TNR = 1-FPR,
  BACCA = mean(BACC),
  MAPE = mean(MAPE), 
  RTMSPE = mean(RTMSPE),
  Time = mean(Time))


```

```{r fig.width=10, fig.height=8, echo=FALSE}
summary3 = summary #%>% filter(df == "Normal")
summary3$BACC = summary3$BACCA
#summary3 = reshape2::melt(summary3, id = "gamma")

summary3
p2 = ggplot(data = summary3, aes(x = gamma, y = BACCA, group = method))+
  geom_point(aes(color = method))+
  geom_line(aes(linetype = method, color = method))+ 
  facet_grid(df~e, scales = "free", space = "free_x") +
  scale_y_continuous(limits = c(0, 1))+
  theme_bw()+
  labs(x = expression(gamma*": magnitude of outlyingness"))+
  theme(text= element_text(size=12), 
        #axis.text.x = element_blank(),
        legend.position = "right")
p2


#ggsave("plots_fpr_p20.eps", plot = p2, width = 10,height = 7)
```


```{r, fig.width=12, fig.height=12}
library(cellWise)
set.seed(5)
dataset = srlmcell::genevar(p = 2, n = 20, beta = c(1,1), df = 0, r = 0, e = 0)


x = dataset$x
x[1,1] = c(6)
x[2,1] = c(-6.5)
y = x[,1] + x[,2]+rnorm(n = 20, sd = 0.5)
x[3,1] = c(6)
x[1,2] = c(6)

fit1 <- DDC(x)



x = rbind(x, fit1$Ximp[1:3,])
label = factor(c(rep(1,20), rep(2,3)),labels = c("Origion", "Imputation"))
x = cbind(x, label)
mat  = as.data.frame(cbind(y,x))
colnames(mat) = c("y", "X1", "X2","label")
#mat$label = factor(c(rep(1,20), 2:4),labels = c("clean observations", "Point a", "Point b", "Point c"))

#pairs(mat[,1:3], pch = 19, xaxt='n', yaxt='n')
upper.panel<-function(x, y){
  points(x,y, pch=19, col=c("black", "red")[mat$label], cex = 2)
  r <- round(cor(x, y), digits=2)
  #usr <- par("usr")
  #on.exit(par(usr))
  # #par(usr = c(0, 1, 0, 1))
  # text(x[3], y[3], "a", col = "white")
  # text(x[2], y[2], "b", col = "white")
  # text(x[1], y[1], "c", col = "white")
  # text(x[23]-0.4, y[23], "a'")
  # text(x[22]-0.4, y[22], "b'")
  # text(x[21]-0.4, y[21], "c'")
}
pairs(mat[,1:3], lower.panel = NULL, 
      upper.panel = upper.panel)


fit1$Ximp[1:3,]
```

```{r}
plot(fit1$Ximp, col = "red", pch = 19, cex = 0.5, xlim = c(-6, 6), ylim = c(-6, 6), font = 1)
points(dataset$x, pch = 19, cex = 0.5,)
#text(fit1$Ximp, labels=1:n, cex=1, font=2)
```


```{r}
upper.panel<-function(x, y){
  points(x,y, pch=19, col=c("red", "green3", "blue")[iris$Species])
  r <- round(cor(x, y), digits=2)
  txt <- paste0("R = ", r)
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  text(0.5, 0.9, txt)
}
pairs(iris[,1:3], lower.panel = NULL, 
      upper.panel = upper.panel)
```


```{r}
library(GGally)

ggpairs(mat, columns = 1:3, ggplot2::aes(colour = label), upper = NULL, , axisLabels="none") 
```




```{r, message = F, warning = F,echo=FALSE}
library(tidyverse)
load("result_regression_new.RData")

result1 = as.data.frame(t(as.data.frame(result)))
result1 = result1 %>% mutate(across(c(1:4, 12:18), as.numeric), 
                             across(5:11, as.factor))

unique(result1$method)
levels(result1$e) = c("e = 0%", "e = 2%", "e = 5%", "e = 10%")
levels(result1$df) = c( "Normal","t(3)", "t(5)")
levels(result1$gamma) = c( "2", "4", "6", "8", "10", " ")
result1$df = factor(result1$df, levels = c("t(3)", "t(5)", "Normal"))

#result1[which.max(result1$MAPE),]
levels(result1$method)
```

```{r , warning = F, echo=FALSE}
result2 = result1
result2[(result2$e=="e = 0%")&(result2$gamma!="2"),]=NA
result2 = result2[complete.cases(result2$m),]
result2$gamma[result2$e=="e = 0%"] = " "
levels(result2$method) = c("RobReg_DDCimp", "RobReg_Rlars_Cell_Restoration","RobReg_Rlars_Row_Restoration",
                           "RobSel_DDCimp", "RobSel_Rlars_Cell_Restoration","RobSel_Rlars_Row_Restoration")
```

```{r}
result_regression_new= result2
save(result_regression_new, file = "result_simu_regression_new_cleaned.RData")
load("result_simu_regression_new_cleaned.RData")
#result_high$method %in% c("sss",   "rlars", "smddcrow", "smddccell", "smrlarsrow", "smrlarscell")
```

```{r fig.width=10, fig.height=10, echo=FALSE}

result3 = result2 %>% filter(df == "Normal")
#result3 = result2 %>% filter(method == "RobReg_DDCimp")
result3 = result3[complete.cases(result3$TPD),]


p1 = ggplot(data = result3)+
  geom_boxplot(aes(fill = method, x = gamma, y = TND))+
  facet_grid(outtype~e, scales = "free", space = "free_x") +
  #scale_y_continuous(limits = c(0,10))+
  theme_bw()+
  labs(x = expression(gamma*": magnitude of outlyingness"))+
  theme(text= element_text(size=12), 
        #axis.text.x = element_blank(),
        legend.position = "right")
p1

result3[which.max(result3$MAPE),]

levels(result3$method)
head(result3$TPD)
#ggsave("plots_time_p200.eps", plot = p1, width = 10,height = 7)
```


```{r}
library(pense)
data(freeny)
x <- as.matrix(freeny[ , 2:5])
regpath <- pense(x, freeny$y, alpha = 0.5)
plot(regpath)
# Extract the coefficients at a certain penalization level
coef(regpath, lambda = regpath$lambda[[1]][[40]])


# What penalization level leads to good prediction performance?
set.seed(123)
cv_results <- pense_cv(x, freeny$y, alpha = 0.5,
cv_repl = 2, cv_k = 4)
plot(cv_results, se_mult = 1)
# Extract the coefficients at the penalization level with
# smallest prediction error ...
coef(cv_results)
# ... or at the penalization level with prediction error
# statistically indistinguishable from the minimum.
coef(cv_results, lambda = '1-se')
```




```{r}
set.seed(5)
data = srlmcell::genevar(n = 20, e = 0.1, p = 20, pr = 5, df = 3,r = 0.5, gamma = 10, outtype = "cellwise")
ximp <- suppressMessages(cellWise::DDC(data$x)$Ximp)
df <- expand.grid(n = 1:20,p = c(1:21))
df$n = as.factor(df$n)
levels(df$n) = as.character(20:1)
df$p = as.factor(df$p)
levels(df$p) = c(" ", as.character(1:20))
df$type = rep(factor(c("Y","X", "X(inactive)"), levels = c("Y","X", "X(inactive)")),times = 20*c(1,5,15))
df$`True outlier` = factor(c(rep(0,20),as.numeric(data$outlierlabel)), labels = c("No", "Yes"))
df$`Detected outlier` = factor(c(rep(0,20),as.numeric(ximp!=data$x)), labels = c("No", "Yes"))
```

```{r, fig.width=10, fig.height=9}
p111 = ggplot(df,aes(p, n)) +
  geom_tile(aes(colour = `Detected outlier`, fill = `True outlier`, size = `Detected outlier`))+
  scale_size_manual(values = c(0.5,1))+
  scale_fill_manual(values=c("gray", "yellow"))+
  scale_color_manual(values=c("black", "red"))+
  facet_grid(.~type,space = "free", scale = "free")+
  theme_minimal()
#ggsave("illis2.eps", plot = p111, width = 10,height = 9)
```













